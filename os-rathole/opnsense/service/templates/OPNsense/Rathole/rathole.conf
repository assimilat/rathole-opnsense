{% if helpers.exists('OPNsense.Rathole.General.enabled') and OPNsense.Rathole.General.enabled == '1' %}
{% set general = OPNsense.Rathole.General %}
{% set servers = OPNsense.Rathole.Servers.server | default([]) %}
{% set keys = OPNsense.Rathole.Keys.key | default([]) %}
{% set ports = OPNsense.Rathole.Ports.port | default([]) %}

[common]
log_level = "{{ general.log_level }}"

{% for server in servers %}
{% if server.enabled == '1' %}
[server.{{ server.name }}]
bind_addr = "{{ server.bind_address }}"
bind_port = {{ server.bind_port }}
{% if server.server_key != '' %}
server_key = "{{ keys[server.server_key].private_key }}"
{% endif %}
{% if server.client_key != '' %}
client_key = "{{ keys[server.client_key].public_key }}"
{% endif %}
{% if server.tls_cert != '' %}
tls_cert = "{{ server.tls_cert }}"
{% endif %}
{% if server.tls_key != '' %}
tls_key = "{{ server.tls_key }}"
{% endif %}
{% if server.tls_root_cert != '' %}
tls_root_cert = "{{ server.tls_root_cert }}"
{% endif %}
{% if server.tls_hostname != '' %}
tls_hostname = "{{ server.tls_hostname }}"
{% endif %}

{% for port in ports %}
{% if port.server_ref == server.uuid and port.enabled == '1' %}
[server.{{ server.name }}.{{ port.name }}]
type = "{{ port.type }}"
local_addr = "{{ port.local_address }}"
local_port = {{ port.local_port }}
remote_port = {{ port.remote_port }}
{% endif %}
{% endfor %}

{% endif %}
{% endfor %}

{% endif %}
